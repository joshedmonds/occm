---
sidebar: sidebar
permalink: task-kubernetes-discover-aws.html
keywords: kubernetes, k8s, back up kubernetes, back up k8s, discover kubernetes cluster, discover k8s, amazon eks, eks, back up persistent volumes, persistent volumes, kubernetes support
summary: Add Amazon Elastic Kubernetes Service (Amazon EKS) clusters to Cloud Manager so that you can start backing up persistent volumes to Amazon S3.
---

= Add your Amazon EKS clusters to Cloud Manager
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Add Amazon Elastic Kubernetes Service (Amazon EKS) clusters to Cloud Manager so that you can start backing up persistent volumes to Amazon S3.

== Quick start

<quick start>

== Requirements

Before you can add an EKS cluster to Cloud Manager, you need to ensure that the following requirements have been met.

Astra Trident::
The EKS cluster must have NetApp Astra Trident installed.
+
https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-operator.html[Learn how to install Astra Trident^].

Cloud Volumes ONTAP::
Cloud Volumes ONTAP for AWS must be set up as backend storage for the cluster.
+
https://docs.netapp.com/us-en/trident/trident-use/backends.html[Learn how to configure backends using Astra Trident^].

Cloud Manager Connector::
A Connector must be running in AWS with the required permissions. Learn more below.

Network connectivity::
Network connectivity must be in place between the EKS cluster, the Connector, and Cloud Volumes ONTAP. Learn more below.

RBAC authorization::
The Cloud Manager Connector role must be authorized on each EKS cluster. Learn more below.

=== Prepare a Connector

A Cloud Manager Connector is required in AWS to discover and manage Amazon EKS clusters. You'll need to create a new Connector or use an existing Connector that has the required permissions.

.Create a new Connector

Follow the steps in one of the links below.

* link:task_creating_connectors_aws.html[Create a Connector from Cloud Manager] (recommended)
* link:task_launching_aws_mktp.html[Create a Connector from the AWS Marketplace]
* link:task_installing_linux.html[Install the Connector on an existing Linux host in AWS]

.Add the required permissions to an existing Connector

. Go the AWS console and open the EC2 service.

. Select the Connector instance, click *Security*, and click the name of the IAM role to view the role in the IAM service.
+
image:screenshot-aws-iam-role.png[A screenshot of the AWS console that shows the name of the IAM role in the Security tab.]

. In the *Permissions* tab, expand the policy and click *Edit policy*.
+
image:screenshot-aws-edit-policy.png[A screenshot of the AWS console that shows the Edit policy button in the Permissions tab.]

. Click *JSON* and add the following permissions under the first set of actions:
+
[source,json]
"eks:ListClusters",
"eks:DescribeCluster,"
"iam:GetInstanceProfile"

+
https://occm-sample-policies.s3.amazonaws.com/Policy_for_Cloud_Manager_3.9.13.json[View the full JSON format for the policy^].

. Click *Review policy* and then click *Save changes*.

=== Review networking requirements

You need to provide network connectivity between the EKS cluster, the Connector, and the Cloud Volumes ONTAP system.

The simplest way to provide this connectivity is to deploy the Connector and Cloud Volumes ONTAP in the same VPC as the EKS cluster. Otherwise, you need to set up a VPC peering connection between the different VPCs.

Here's an example that shows each component in the same VPC.

<example>

=== Set up RBAC authorization for each EKS cluster

You need to authorize the Connector role on each EKS cluster so the Connector can discover and manage a cluster.

.Steps

. Create a cluster role and role binding.

.. Create a YAML file that includes the following text.
+
[source,yaml]
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
    name: cloudmanager-access-clusterrole
rules:
    - apiGroups:
          - ''
      resources:
          - secrets
          - namespaces
          - persistentvolumeclaims
          - persistentvolumes
      verbs:
          - get
          - list
          - create
    - apiGroups:
          - storage.k8s.io
      resources:
          - storageclasses
      verbs:
          - get
          - list
    - apiGroups:
          - trident.netapp.io
      resources:
          - tridentbackends
          - tridentorchestrators
      verbs:
          - get
          - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
    name: k8s-access-binding
subjects:
    - kind: Group
      name: cloudmanager-access-group
      apiGroup: rbac.authorization.k8s.io
roleRef:
    kind: ClusterRole
    name: cloudmanager-access-clusterrole
    apiGroup: rbac.authorization.k8s.io

.. Apply the configuration to a cluster.
+
[source,kubectl]
kubectl apply -f <file-name>

. Create an identity mapping to the permissions group.

// start tabbed area

[role="tabbed-block"]
====

.Use eksctl
--

Use eksctl to create an IAM identity mapping between a cluster and the IAM role for the Cloud Manager Connector.

https://eksctl.io/usage/iam-identity-mappings/[Go to the eksctl documentation for full instructions^].

An example is provided below.

[source,eksctl]
eksctl create iamidentitymapping --cluster <eksCluster> --region <us-east-2> --arn <ARN of the Connector IAM role> --group cloudmanager-access-group --username system:node:{{EC2PrivateDNSName}}
--

.Edit aws-auth
--
Directly edit the aws-auth ConfigMap to add RBAC access to the IAM role for the Cloud Manager Connector.

https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html[Go to the Amazon EKS documentation for full instructions^].

An example is provided below.

[source,yaml]
apiVersion: v1
data:
  mapRoles: |
    - groups:
      - cloudmanager-access-group
      rolearn: <ARN of the Connector IAM role>
     username: system:node:{{EC2PrivateDNSName}}
kind: ConfigMap
metadata:
  creationTimestamp: "2021-09-30T21:09:18Z"
  name: aws-auth
  namespace: kube-system
  resourceVersion: "1021"
  selfLink: /api/v1/namespaces/kube-system/configmaps/aws-auth
  uid: dcc31de5-3838-11e8-af26-02e00430057c
--

====

== Add a Kubernetes cluster working environment



.Steps

.
